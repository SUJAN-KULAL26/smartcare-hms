<!DOCTYPE html>
<html>
<head>
  <title>SmartCare HMS - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin:0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      min-height:100vh;
      color:white;
      position:relative;
      overflow-x:hidden;
    }

    /* Background glow effect */
    body::before, body::after {
      content:"";
      position:absolute;
      width:400px;
      height:400px;
      border-radius:50%;
      filter:blur(150px);
      z-index:-1;
    }

    body::before {
      background: rgba(0,123,255,0.3);
      top:-150px;
      left:-150px;
    }

    body::after {
      background: rgba(0,255,255,0.2);
      bottom:-150px;
      right:-150px;
    }

    /* NAVBAR */
    .navbar {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      padding:15px 30px;
      display:flex;
      gap:25px;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.15);
    }

    .navbar a {
      color:#ddd;
      text-decoration:none;
      font-weight:500;
      transition:0.3s;
    }

    .navbar a:hover {
      color:#00c6ff;
    }

    .navbar button {
      margin-left:auto;
      background: linear-gradient(90deg,#00c6ff,#0072ff);
      border:none;
      padding:8px 18px;
      border-radius:25px;
      color:white;
      cursor:pointer;
      font-weight:bold;
    }

    .container {
      padding:40px;
      max-width:1200px;
      margin:auto;
    }

    h2 {
      margin-bottom:30px;
      font-weight:600;
    }

    /* CARDS */
    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:25px;
      margin-bottom:40px;
    }

    .card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(15px);
      padding:25px;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.15);
      text-align:center;
      transition:0.3s;
    }

    .card:hover {
      transform:translateY(-5px);
    }

    .card h4 {
      color:#ccc;
      margin-bottom:10px;
    }

    .card h2 {
      color:#00c6ff;
      font-size:28px;
    }

    /* CHART SECTION */
    .charts {
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:30px;
    }

    .chart-card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(15px);
      padding:25px;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.15);
      height:400px;
      display:flex;
      flex-direction:column;
    }

    .chart-card h3 {
      margin-bottom:20px;
      color:#ddd;
    }

    canvas {
      max-height:280px !important;
    }

  </style>
</head>

<body>

<div class="navbar">
  <a href="/dashboard.html">Dashboard</a>
  <a href="/patients.html">Patients</a>
  <a href="/doctors.html">Doctors</a>
  <a href="/appointments.html">Appointments</a>
  <a href="/billing.html">Billing</a>
  <a href="/reports.html">Reports</a>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">

  <h2>Dashboard Overview</h2>

  <div class="cards">
    <div class="card">
      <h4>Total Revenue</h4>
      <h2 id="totalRevenue">₹0</h2>
    </div>

    <div class="card">
      <h4>Today's Revenue</h4>
      <h2 id="todayRevenue">₹0</h2>
    </div>

    <div class="card">
      <h4>Unpaid Amount</h4>
      <h2 id="unpaidAmount">₹0</h2>
    </div>

    <div class="card">
      <h4>Total Patients</h4>
      <h2 id="totalPatients">0</h2>
    </div>

    <div class="card">
      <h4>Total Doctors</h4>
      <h2 id="totalDoctors">0</h2>
    </div>

    <div class="card">
      <h4>Total Appointments</h4>
      <h2 id="totalAppointments">0</h2>
    </div>
  </div>

  <div class="charts">
    <div class="chart-card">
      <h3>Monthly Revenue Trend</h3>
      <canvas id="revenueChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>Revenue by Doctor</h3>
      <canvas id="doctorRevenueChart"></canvas>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const token=localStorage.getItem("token");
const API="https://smartcare-hms-backend.onrender.com/api";

if(!token){
  window.location.href="/";
  return;
}

async function loadRevenue(){
  const res=await fetch(`${API}/billing/report/summary`,{
    headers:{ Authorization:"Bearer "+token }
  });
  const data=await res.json();

  totalRevenue.innerText="₹"+(data.totalRevenue||0);
  todayRevenue.innerText="₹"+(data.todayRevenue||0);
  unpaidAmount.innerText="₹"+(data.unpaidAmount||0);
}

async function loadRevenueChart() {
  const res = await fetch(`${API}/billing/report/monthly`, {
    headers: { Authorization: "Bearer " + token }
  });

  const data = await res.json();

  const monthNames = [
    "Jan","Feb","Mar","Apr","May","Jun",
    "Jul","Aug","Sep","Oct","Nov","Dec"
  ];

  const ctx = document.getElementById("revenueChart").getContext("2d");

  new Chart(ctx, {
    type: "line",
    data: {
      labels: data.map(d => monthNames[d._id - 1]),
      datasets: [{
        label: "Monthly Revenue ₹",
        data: data.map(d => d.total),
        borderColor: "#00c6ff",
        backgroundColor: "rgba(0,198,255,0.2)",
        fill: true,
        tension: 0.4,
        pointRadius:5
      }]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:"#ccc" } }
      },
      scales:{
        x:{ ticks:{ color:"#aaa" } },
        y:{ ticks:{ color:"#aaa" } }
      }
    }
  });
}

let doctorChart;

async function loadDoctorRevenueChart() {
  const res = await fetch(`${API}/billing/report/doctor-wise`, {
    headers: { Authorization: "Bearer " + token }
  });

  const data = await res.json();

  const ctx = document.getElementById("doctorRevenueChart").getContext("2d");

  if (doctorChart) doctorChart.destroy();

  doctorChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: data.map(d => d.doctorName),
      datasets: [{
        data: data.map(d => d.total),
        backgroundColor: [
          "#00c6ff","#28a745","#ffc107","#dc3545","#6f42c1","#17a2b8"
        ]
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      cutout:"60%",
      plugins:{
        legend:{ labels:{ color:"#ccc" } }
      }
    }
  });
}

async function loadCounts(){
  const patients=await fetch(`${API}/patients`,{
    headers:{ Authorization:"Bearer "+token }
  }).then(r=>r.json());

  const doctors=await fetch(`${API}/doctors`,{
    headers:{ Authorization:"Bearer "+token }
  }).then(r=>r.json());

  const appointments=await fetch(`${API}/appointments`,{
    headers:{ Authorization:"Bearer "+token }
  }).then(r=>r.json());

  totalPatients.innerText=patients.length;
  totalDoctors.innerText=doctors.length;
  totalAppointments.innerText=appointments.length;
}

window.logout=function(){
  localStorage.clear();
  window.location.href="/";
};

loadRevenue();
loadCounts();
loadRevenueChart();
loadDoctorRevenueChart();

});
</script>

</body>
</html>