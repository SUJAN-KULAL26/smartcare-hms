<!DOCTYPE html>
<html>
<head>
  <title>SmartCare HMS - Billing</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin:0;
      font-family:'Segoe UI',sans-serif;
      background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      min-height:100vh;
      color:white;
      position:relative;
      overflow-x:hidden;
    }

    /* Background Glow */
    body::before, body::after {
      content:"";
      position:absolute;
      width:400px;
      height:400px;
      border-radius:50%;
      filter:blur(150px);
      z-index:-1;
    }

    body::before {
      background: rgba(0,123,255,0.3);
      top:-150px;
      left:-150px;
    }

    body::after {
      background: rgba(0,255,255,0.2);
      bottom:-150px;
      right:-150px;
    }

    /* NAVBAR */
    .navbar {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      padding:15px 30px;
      display:flex;
      gap:25px;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.15);
    }

    .navbar a {
      color:#ddd;
      text-decoration:none;
      font-weight:500;
      transition:0.3s;
    }

    .navbar a:hover {
      color:#00c6ff;
    }

    .navbar button {
      margin-left:auto;
      background: linear-gradient(90deg,#00c6ff,#0072ff);
      border:none;
      padding:8px 18px;
      border-radius:25px;
      color:white;
      cursor:pointer;
      font-weight:bold;
    }

    .container {
      padding:40px;
      max-width:1200px;
      margin:auto;
    }

    h3 {
      margin-bottom:20px;
      color:#ddd;
    }

    /* GLASS CARD */
    .card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(15px);
      padding:25px;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.15);
      margin-bottom:30px;
    }

    /* FORM */
    .form-row {
      display:flex;
      gap:15px;
      flex-wrap:wrap;
    }

    input, select {
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color:rgb(12, 1, 1);
      flex:1;
      min-width:160px;
      outline:none;
      transition:0.3s;
    }

    input:focus, select:focus {
      border-color:#00c6ff;
    }

    .primary-btn {
      background: linear-gradient(90deg,#00c6ff,#0072ff);
      border:none;
      border-radius:25px;
      padding:12px 25px;
      cursor:pointer;
      color:white;
      font-weight:bold;
      transition:0.3s;
    }

    .primary-btn:hover {
      transform:translateY(-3px);
    }

    /* TABLE */
    table {
      width:100%;
      border-collapse:collapse;
    }

    th, td {
      padding:14px;
      text-align:center;
    }

    th {
      background: rgba(255,255,255,0.15);
      color:#ddd;
    }

    tr {
      border-bottom:1px solid rgba(255,255,255,0.1);
    }

    tr:hover {
      background: rgba(255,255,255,0.05);
    }

    .status-paid {
      color:#28a745;
      font-weight:bold;
    }

    .status-unpaid {
      color:#ffc107;
      font-weight:bold;
    }

  </style>
</head>

<body>

<div class="navbar">
  <a href="/dashboard.html">Dashboard</a>
  <a href="/patients.html">Patients</a>
  <a href="/doctors.html">Doctors</a>
  <a href="/appointments.html">Appointments</a>
  <a href="/billing.html">Billing</a>
  <a href="/reports.html">Reports</a>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">

  <div class="card">
    <h3>Create Bill</h3>
    <div class="form-row">
      <select id="billAppointment"></select>
      <input type="number" id="consultationFee" placeholder="Consultation Fee">
      <input type="number" id="extraCharges" placeholder="Extra Charges">
      <select id="paymentMethod">
        <option value="">Payment Method</option>
        <option>Cash</option>
        <option>UPI</option>
        <option>Card</option>
      </select>
      <button class="primary-btn" onclick="createBill()">Generate</button>
    </div>
  </div>

  <div class="card">
    <h3>Bill List</h3>
    <table>
      <thead>
        <tr>
          <th>Patient</th>
          <th>Doctor</th>
          <th>Total</th>
          <th>Payment Method</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="billTable"></tbody>
    </table>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const token=localStorage.getItem("token");
const API="https://smartcare-hms-backend.onrender.com/api";

if(!token){
  window.location.href="/";
  return;
}

async function loadBillingAppointments(){
  const res=await fetch(`${API}/appointments`,{
    headers:{ Authorization:"Bearer "+token }
  });
  const data=await res.json();
  billAppointment.innerHTML="<option>Select Appointment</option>";
  data.forEach(a=>{
    billAppointment.innerHTML+=`
      <option value="${a._id}">
        ${a.patient?.name} - ${a.doctor?.name}
      </option>`;
  });
}

async function loadBills(){
  const res=await fetch(`${API}/billing`,{
    headers:{ Authorization:"Bearer "+token }
  });
  const data=await res.json();
  const table=document.getElementById("billTable");
  table.innerHTML="";

  data.forEach(b=>{
    table.innerHTML+=`
      <tr>
        <td>${b.patient?.name}</td>
        <td>${b.doctor?.name}</td>
        <td>â‚¹${b.totalAmount}</td>
        <td>${b.paymentMethod}</td>
        <td class="${b.paymentStatus==="Paid"?"status-paid":"status-unpaid"}">
          ${b.paymentStatus}
        </td>
        <td>${new Date(b.createdAt).toLocaleDateString()}</td>
      </tr>`;
  });
}

window.createBill = async function () {

  if (!billAppointment.value) {
    alert("Please select appointment");
    return;
  }

  if (!consultationFee.value) {
    alert("Enter consultation fee");
    return;
  }

  if (!paymentMethod.value) {
    alert("Select payment method");
    return;
  }

  const res = await fetch(`${API}/billing`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({
      appointmentId: billAppointment.value,
      consultationFee: Number(consultationFee.value),
      extraCharges: Number(extraCharges.value || 0),
      paymentMethod: paymentMethod.value
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error || "Failed to generate bill");
    return;
  }

  alert("Bill Generated Successfully!");
  loadBills();
};

window.logout=function(){
  localStorage.clear();
  window.location.href="/";
};

loadBillingAppointments();
loadBills();

});
</script>

</body>
</html>